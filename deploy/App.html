<!DOCTYPE html>
<html>
<head>
    <title>S854907-PIScopeChangeSummary</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",_initDate:void 0,_endDate:void 0,_myMask:void 0,_baseReleaseName:void 0,_baseReleaseId:void 0,_releases:void 0,_initFeatures:void 0,_endFeatures:void 0,_initDefects:void 0,_endDefects:void 0,items:[{xtype:"container",itemId:"header",cls:"header"},{xtype:"container",itemId:"bodyContainer",width:"100%",autoScroll:!0}],launch:function(){var e=this.getContext().getProject().ObjectID;console.log("project:",e),this._projectId=e,this._myMask=new Ext.LoadMask({msg:"Please wait...",target:this});var t=Ext.create("Ext.form.field.Date",{fieldLabel:"Start Date:",listeners:{select:function(e,t){this._initDate=t.toISOString()},scope:this}}),a=Ext.create("Ext.form.field.Date",{fieldLabel:"End Date:",listeners:{select:function(e,t){this._endDate=t.toISOString()},scope:this}}),o=Ext.create("Rally.ui.combobox.ReleaseComboBox",{itemId:"releaseComboBox",fieldLabel:"Release",showArrows:!1,width:450,listeners:{ready:function(e){this._baseReleaseId=e.getRecord().get("ObjectID"),this._baseReleaseName=e.getRecord().get("Name")},select:function(e,t,a){this._baseReleaseId=e.getRecord().get("ObjectID"),this._baseReleaseName=e.getRecord().get("Name")},scope:this}}),r=Ext.create("Rally.ui.Button",{text:"Search",margin:"10 10 10 100",scope:this,handler:function(){this._doSearch()}});this.down("#header").add([{xtype:"panel",title:"PI Scope Change Filter:",layout:"vbox",align:"stretch",autoHeight:!0,bodyPadding:10,items:[{xtype:"fieldcontainer",layout:"hbox",width:800,items:[t,{xtype:"label",flex:1,margin:"0 0 0 20",name:"labelInit",text:"This represents the date of the commitment of the PI"}]},{xtype:"fieldcontainer",layout:"hbox",width:800,items:[a,{xtype:"label",flex:1,margin:"0 0 0 20",name:"labelEnd",text:"This represent the date you want to compare to - usually current date"}]},o,r]}])},_doSearch:function(){console.log("looking for data at:",this._initDate,this._endDate),(this._initDate&&""!==this._initDate||this._endDate&&""!==this._endDate)&&(this._loadReleases(),this._myMask.show())},_loadReleases:function(){Ext.create("Rally.data.wsapi.Store",{model:"Release",autoLoad:!0,context:{projectScopeUp:!1,projectScopeDown:!0,project:null},filters:Rally.data.QueryFilter.or([Rally.data.QueryFilter.and([{property:"Project.ObjectID",value:this._projectId},{property:"name",value:this._baseReleaseName}]),Rally.data.QueryFilter.or([Rally.data.QueryFilter.and([{property:"Project.parent.ObjectID",value:this._projectId},{property:"name",value:this._baseReleaseName}]),Rally.data.QueryFilter.and([{property:"Project.parent.parent.ObjectID",value:this._projectId},{property:"name",value:this._baseReleaseName}])])]),listeners:{load:function(e,t,a){if(t.length>0){console.log("multiple releases found:",t);var o=[];_.each(t,function(e){o.push(e.get("ObjectID"))}),this._releases=o,console.log("releases: ",this._releases)}else console.log("single release found, using baseReleaseId:",baseReleaseId),this._releases=[baseReleaseId];this._loadInitFeatures()},scope:this},fetch:["Description","Name","ObjectID"],limit:1/0})},_loadInitFeatures:function(){var e=Ext.create("Deft.Deferred");console.log("loading init Features",this._initDate,this._endDate,this._projectId,this._baseReleaseId);var t=[{property:"__At",value:this._initDate},{property:"_TypeHierarchy",value:"PortfolioItem/Feature"},{property:"_ProjectHierarchy",value:this._projectId},{property:"Release",operator:"in",value:this._releases}];console.log("filters:",t);Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["Name","FormattedID","LeafStoryPlanEstimateTotal","LeafStoryCount","PreliminaryEstimate","State","Parent","PercentDoneByStoryPlanEstimate","_ValidFrom","_ValidTo"],hydrate:["State","Project"],filters:t,autoLoad:!0,limit:1/0,sorters:[{property:"ObjectID",direction:"ASC"}],listeners:{load:function(t,a,o){console.log("Features data loaded:",a),this._initFeatures=a,console.log(a),this._loadEndFeatures(),e.resolve(a)},scope:this}});return e.promise},_loadEndFeatures:function(){var e=Ext.create("Deft.Deferred");console.log("loading end Features",this._initDate,this._projectId);var t=[{property:"__At",value:this._endDate},{property:"_TypeHierarchy",value:"PortfolioItem/Feature"},{property:"_ProjectHierarchy",value:this._projectId},{property:"Release",operator:"in",value:this._releases}];Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["Name","FormattedID","LeafStoryPlanEstimateTotal","LeafStoryCount","PreliminaryEstimate","State","Parent","PercentDoneByStoryPlanEstimate","_ValidFrom","_ValidTo"],hydrate:["State","Project"],filters:t,autoLoad:!0,limit:1/0,sorters:[{property:"ObjectID",direction:"ASC"}],listeners:{load:function(t,a,o){console.log("end Features data loaded:",a),this._endFeatures=a,console.log(a),this._buildSummaryProject(),this._buildSummaryType(),e.resolve(a)},scope:this}});return e.promise},_loadInitDefects:function(){var e=Ext.create("Deft.Deferred");console.log("loading init Defects",this._initDate,this._projectId);var t=[{property:"__At",value:this._initDate},{property:"_TypeHierarchy",value:"Defect"},{property:"_ProjectHierarchy",value:this._projectId},{property:"Release",operator:"in",value:this._releases}];Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["Name","FormattedID","ObjectID","Project","ScheduleState","PlanEstimate","_ValidFrom","_ValidTo"],hydrate:["ScheduleState","Project"],filters:t,autoLoad:!0,limit:1/0,sorters:[{property:"ObjectID",direction:"ASC"}],listeners:{load:function(t,a,o){console.log("defects data loaded:",a),this._initDefects=a,e.resolve(a)},scope:this}});return e.promise},_loadEndDefects:function(){var e=Ext.create("Deft.Deferred");console.log("loading end Defects",this._endDate,this._projectId);var t=[{property:"__At",value:this._endDate},{property:"_TypeHierarchy",value:"Defect"},{property:"_ProjectHierarchy",value:this._projectId},{property:"Release",operator:"in",value:this._releases}];Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["Name","FormattedID","ObjectID","ScheduleState","Project","PlanEstimate","_ValidFrom","_ValidTo"],hydrate:["ScheduleState","Project"],filters:t,autoLoad:!0,limit:1/0,sorters:[{property:"ObjectID",direction:"ASC"}],listeners:{load:function(t,a,o){console.log("defects data loaded:",a),this._endDefects=a,e.resolve(a)},scope:this}});return e.promise},_buildSummaryProject:function(){var e=this._createSummaryProjectStore(),t=Ext.create("Ext.grid.Panel",{store:e,forceFit:!0,viewConfig:{enableTextSelection:!0},columns:[{text:"Summary by Projects",flex:3,sortable:!1,dataIndex:"projectName"},{text:"Total Start Day",flex:1,sortable:!1,dataIndex:"totalStartDay"},{text:"Total End Day",flex:1,sortable:!1,dataIndex:"totalEndDay"},{text:"Adds",flex:1,sortable:!1,dataIndex:"adds"},{text:"Deletes",flex:1,sortable:!1,dataIndex:"deletes"},{text:"% Change",flex:1,sortable:!1,dataIndex:"percChange"}]});this.down("#bodyContainer").removeAll(!0),this.down("#bodyContainer").add(t),this._myMask.hide()},_buildSummaryType:function(){var e=this._createSummaryTypeStore(),t=Ext.create("Ext.grid.Panel",{store:e,margin:"20 0 0 0",forceFit:!0,viewConfig:{enableTextSelection:!0},columns:[{text:"Summary by Type",flex:3,sortable:!1,dataIndex:"typeName"},{text:"Total Start Day",flex:1,sortable:!1,dataIndex:"totalStartDay"},{text:"Total End Day",flex:1,sortable:!1,dataIndex:"totalEndDay"},{text:"Adds",flex:1,sortable:!1,dataIndex:"adds"},{text:"Deletes",flex:1,sortable:!1,dataIndex:"deletes"},{text:"% Change",flex:1,sortable:!1,dataIndex:"percChange"}]});this.down("#bodyContainer").add(t),this._myMask.hide()},_createSummaryTypeStore:function(){var e=[],t=0,a=0,o=0,r=0,s=[],i=[];_.each(this._initFeatures,function(e){s.push(e.get("ObjectID"))},this),_.each(this._endFeatures,function(e){i.push(e.get("ObjectID"))},this),_.each(this._initFeatures,function(e){var a=e.get("ObjectID");Ext.Array.contains(i,a)?t+=e.get("LeafStoryPlanEstimateTotal"):o+=e.get("LeafStoryPlanEstimateTotal")},this),_.each(this._endFeatures,function(e){var t=e.get("ObjectID");Ext.Array.contains(s,t)?a+=e.get("LeafStoryPlanEstimateTotal"):r+=e.get("LeafStoryPlanEstimateTotal")},this);var l=0;a>t&&(l=(100-a/t*100).toFixed(2)+"%"),t>a&&(l="-"+(100-a/t*100).toFixed(2)+"%"),e.push({typeName:"Feature",totalStartDay:t,totalEndDay:a,adds:r,deletes:o,percChange:l}),console.log("rows",e);var n=Ext.create("Ext.data.JsonStore",{fields:["typeName","totalStartDay","totalEndDay","adds","deletes","percChange"]});return n.loadData(e),n},_createSummaryProjectStore:function(){var e=[],t=new Ext.util.MixedCollection,a=new Ext.util.MixedCollection;_.each(this._initFeatures,function(e){var a=e.get("Project").Name;if(t.containsKey(a))t.get(a).push(e);else{var o=[];o.push(e),t.add(a,o)}},this),_.each(this._endFeatures,function(e){var t=e.get("Project").Name;if(a.containsKey(t))a.get(t).push(e);else{var o=[];o.push(e),a.add(t,o)}},this),t.eachKey(function(t,o){console.log("map init:",t,o);var r=0;_.each(o,function(e){r+=e.get("LeafStoryPlanEstimateTotal")},this);var s=this._calculateTotalEndDay(t,a),i=this._calculateAdds(r,s),l=this._calculateDeletes(r,s),n=0;i>0&&0===l&&(n=(i/r*100).toFixed(2)+"%"),l>0&&0===i&&(n="-"+(l/r*100).toFixed(2)+"%");var d={projectName:t,totalStartDay:r,totalEndDay:s,adds:i,deletes:l,percChange:n};e.push(d)},this),console.log("rows",e);var o=Ext.create("Ext.data.JsonStore",{fields:["projectName","totalStartDay","totalEndDay","adds","deletes","percChange"]});return o.loadData(e),o},_calculateTotalEndDay:function(e,t){if(t.containsKey(e)){var a=0;return _.each(t.get(e),function(e){a+=e.get("LeafStoryPlanEstimateTotal")},this),a}return 0},_calculateAdds:function(e,t){var a=0;return t>e&&(a=t-e),a},_calculateDeletes:function(e,t){var a=0;return t<e&&(a=e-t),a}});

            Rally.launchApp('CustomApp', {
                name:"S854907-PIScopeChangeSummary",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
